<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Season Numbering Tabelle</title>
<style>
/* Tabelle Desktop */

table {
  border-collapse: collapse;
  width: 100%;
  table-layout: auto;
}
td {
  border: 1px solid #999;
  padding: 2px;
  text-align: center;
  font-size: 11px;
}
td.col-b {
  width: 80px;
  white-space: nowrap;
}

/* Spalten A und B fett (nur Haupttabelle) */
#episodes-table tr td:nth-child(1),
#episodes-table tr td:nth-child(2) {
  font-weight: bold;
}

/* Trennlinie vor Beginn einer neuen Staffel */
tr.season-start td {
  border-top: 3px solid #000;
}

/* Legend: keine Klicks */
.legend-table td { pointer-events: none; cursor: default; }

/* Klickbare Episoden-Zellen */
.clickable { cursor: pointer; }

/* Mobile Layout */
@media (max-width: 600px) {
  table, thead, tbody, th, td, tr { display: block; }
  tr { margin-bottom: 8px; border: 1px solid #999; border-radius: 4px; padding: 4px; }
  td { display: flex; justify-content: space-between; padding: 4px; border: none; border-bottom: 1px solid #ddd; }
  td:last-child { border-bottom: none; }
  td::before { content: attr(data-label); font-weight: bold; }
}
</style>
<script>
document.addEventListener("DOMContentLoaded", function() {
  function centerPopup(el){
    const vv = window.visualViewport;
    const vpW = vv ? vv.width : window.innerWidth;
    const vpH = vv ? vv.height : window.innerHeight;
    const scrollX = vv ? vv.pageLeft : window.scrollX;
    const scrollY = vv ? vv.pageTop : window.scrollY;
    // sicherstellen, dass Größe berechnet werden kann
    const rect = el.getBoundingClientRect();
    let left = scrollX + (vpW - rect.width)/2;
    let top = scrollY + (vpH - rect.height)/2;
    left = Math.max(scrollX + 8, left);
    top = Math.max(scrollY + 8, top);
    el.style.left = left + 'px';
    el.style.top = top + 'px';
    // Falls durch Zoom außerhalb, sanft scrollen
    const after = el.getBoundingClientRect();
    const within = after.top >= 0 && after.left >= 0 && after.bottom <= (window.innerHeight || document.documentElement.clientHeight) && after.right <= (window.innerWidth || document.documentElement.clientWidth);
    if(!within){
      el.scrollIntoView({behavior:'smooth', block:'center'});
    }
  }
    const popup = document.createElement("div");
    popup.id = "popup";
    popup.style.display = "none";
    popup.style.position = "absolute";
    popup.style.background = "#fff";
    popup.style.border = "1px solid #999";
    popup.style.padding = "10px";
    popup.style.borderRadius = "8px";
    popup.style.boxShadow = "0 4px 8px rgba(0,0,0,0.2)";
    popup.style.maxWidth = "300px";
    popup.style.zIndex = "9999";
    popup.innerHTML = `
        <div id="popup-content"></div>
        <button id="popup-close" style="margin-top:6px;">Schließen</button>
    `;
    document.body.appendChild(popup);
    document.getElementById("popup-close").addEventListener("click", () => {
        popup.style.display = "none";
    });
  document.querySelectorAll("#episodes-table .episode-cell").forEach(cell => {
        cell.addEventListener("click", function(event) {
            const season = this.dataset.season;
            const ep = this.dataset.ep;
      const isMovie = this.dataset.movie === '1';
      const raw = this.dataset.raw || '';
      if (isMovie) {
        if (!raw) return;
        fetch(`/get_movie/${encodeURIComponent(raw)}`)
          .then(r => { if(!r.ok) throw new Error('Serverfehler'); return r.text(); })
          .then(code => {
            document.getElementById("popup-content").innerHTML = code;
            popup.style.display = 'block';
            centerPopup(popup);
          })
          .catch(err => {
            document.getElementById("popup-content").innerText = 'Fehler: '+err;
            popup.style.display = 'block';
            centerPopup(popup);
          });
        return;
      }
      if (!season || !ep) return;
      fetch(`/get_code/${season}/${ep}`)
                .then(response => {
                    if (!response.ok) throw new Error("Serverfehler");
                    return response.text();
                })
                .then(code => {
          document.getElementById("popup-content").innerHTML = code;
          popup.style.display = "block";
          centerPopup(popup);
                })
                .catch(err => {
          document.getElementById("popup-content").innerText = "Fehler: " + err;
          popup.style.display = "block";
          centerPopup(popup);
                });
        });
    });
    document.addEventListener("click", function(e) {
        if (!popup.contains(e.target) && !e.target.classList.contains("episode-cell")) {
            popup.style.display = "none";
        }
    });
});
</script>
</head>
<body>
<h2>Wichtige Episoden</h2>
<table id="episodes-table">
{% for r in range(data|length) %}
  {% set row_data = data[r] %}
  {% set row_colors = colors[r] %}
  {% set season_name = row_data[0][0] %}
  {% set prev_season = data[r-1][0][0] if r>0 else None %}
  {# Zeile nur rendern wenn irgendeine Zelle ab Spalte 1 Inhalt hat #}
  {% set ns = namespace(nonempty=false) %}
  {% for cell_tpl in row_data[1:] %}
    {% if cell_tpl[0] not in (None, '') %}{% set ns.nonempty = true %}{% endif %}
  {% endfor %}
  {% if ns.nonempty %}
  {% set row_class = '' %}
  {% if season_name and season_name != prev_season %}
    {% set row_class = 'season-start' %}
  {% endif %}
  <tr class="{{ row_class }}">
      {% for c in range(0,2) %}
        {% set cell_value, season, ep_in_season = row_data[c] %}
  <td class="{{ 'col-b' if c == 1 else '' }}{% if c != 1 %} episode-cell{% endif %}"
      style="background-color: {{ row_colors[c] }};"
      data-season="{{ season if season is not none else '' }}"
      data-ep="{{ ep_in_season if ep_in_season is not none else '' }}"
      data-movie="0"
      data-raw="{{ cell_value|e }}">
      {{ cell_value if cell_value is not none else "" }}
        </td>
      {% endfor %}
      {% set end_index = 18 if row_data|length > 18 else row_data|length %}
      {% for c in range(2, end_index) %}
        {% set cell_value, season, ep_in_season = row_data[c] %}
    {% set is_movie = 1 if pink_flags[r][c] else 0 %}
    <td style="background-color: {{ row_colors[c] }};"
      data-season="{{ season if season is not none else '' }}"
      data-ep="{{ ep_in_season if ep_in_season is not none else '' }}"
      data-movie="{{ is_movie }}"
      data-raw="{{ cell_value|e }}"
      class="episode-cell {{ 'movie-cell' if is_movie else '' }} {% if cell_value %}clickable{% endif %}">
    {{ cell_value if cell_value is not none else "" }}
        </td>
      {% endfor %}
    </tr>
  {% for start in range(18, row_data|length, 16) %}
      {% set chunk = namespace(nonempty=false) %}
      {% for c in range(start, start + 16) %}
        {% if c < row_data|length and row_data[c][0] not in (None, '') %}{% set chunk.nonempty = true %}{% endif %}
      {% endfor %}
      {% if chunk.nonempty %}
      <tr>
        <td></td><td></td>
        {% for c in range(start, start + 16) %}
          {% if c < row_data|length %}
            {% set cell_value, season, ep_in_season = row_data[c] %}
      {% set is_movie_chunk = 1 if pink_flags[r][c] else 0 %}
      <td style="background-color: {{ row_colors[c] }};"
        data-season="{{ season if season is not none else '' }}"
        data-ep="{{ ep_in_season if ep_in_season is not none else '' }}"
        data-movie="{{ is_movie_chunk }}"
        data-raw="{{ cell_value|e }}"
        class="episode-cell {{ 'movie-cell' if is_movie_chunk else '' }} {% if cell_value %}clickable{% endif %}">
      {{ cell_value if cell_value is not none else "" }}
            </td>
          {% endif %}
        {% endfor %}
      </tr>
      {% endif %}
  {% endfor %}
    {% endif %}
{% endfor %}
</table>
{% if legend and legend|length > 0 %}
<h3>Legende</h3>
<table class="legend-table" style="margin-top:12px; border-collapse:collapse;">
  {% for row in legend %}
    <tr>
      {% for value,color in row %}
        <td style="background-color: {{ color }}; padding:4px; font-size:10px; border:1px solid #666; text-align:left; white-space:nowrap;">
          {{ value }}
        </td>
      {% endfor %}
    </tr>
  {% endfor %}
</table>
{% endif %}
</body>
</html>
